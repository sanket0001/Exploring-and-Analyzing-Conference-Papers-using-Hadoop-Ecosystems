


Paper ID = 5891
Title = A Complete Recipe for Stochastic Gradient MCMC
Yi-An Ma, Tianqi Chen, and Emily B. Fox
University of Washington {yianma@u,tqchen@cs,ebfox@stat}.washington.edu
Abstract
Many recent Markov chain Monte Carlo (MCMC) samplers leverage continuous
dynamics to define a transition kernel that efficiently explores a target distribution.
In tandem, a focus has been on devising scalable variants that subsample the data
and use stochastic gradients in place of full-data gradients in the dynamic simu-
lations. However, such stochastic gradient MCMC samplers have lagged behind
their full-data counterparts in terms of the complexity of dynamics considered
since proving convergence in the presence of the stochastic gradient noise is non-
trivial. Even with simple dynamics, significant physical intuition is often required
to modify the dynamical system to account for the stochastic gradient noise. In this
paper, we provide a general recipe for constructing MCMC samplers‚Äîincluding
stochastic gradient versions‚Äîbased on continuous Markov processes specified vi-
a two matrices. We constructively prove that the framework is complete. That is,
any continuous Markov process that provides samples from the target distribution
can be written in our framework. We show how previous continuous-dynamic
samplers can be trivially ‚Äúreinvented‚Äù in our framework, avoiding the complicated
sampler-specific proofs. We likewise use our recipe to straightforwardly propose
a new state-adaptive sampler: stochastic gradient Riemann Hamiltonian Monte
Carlo (SGRHMC). Our experiments on simulated data and a streaming Wikipedi-
a analysis demonstrate that the proposed SGRHMC sampler inherits the benefits
of Riemann HMC, with the scalability of stochastic gradient methods.
1 Introduction
Markov chain Monte Carlo (MCMC) has become a defacto tool for Bayesian posterior inference.
However, these methods notoriously mix slowly in complex, high-dimensional models and scale
poorly to large datasets. The past decades have seen a rise in MCMC methods that provide more effi-
cient exploration of the posterior, such as Hamiltonian Monte Carlo (HMC) [8, 12] and its Reimann
manifold variant [10]. This class of samplers is based on defining a potential energy function in
terms of the target posterior distribution and then devising various continuous dynamics to explore
the energy landscape, enabling proposals of distant states. The gain in efficiency of exploration often
comes at the cost of a significant computational burden in large datasets.
Recently, stochastic gradient variants of such continuous-dynamic samplers have proven quite useful
in scaling the methods to large datasets [17, 1, 6, 2, 7]. At each iteration, these samplers use data
subsamples‚Äîor minibatches‚Äîrather than the full dataset. Stochastic gradient Langevin dynamics
(SGLD) [17] innovated in this area by connecting stochastic optimization with a first-order Langevin
dynamic MCMC technique, showing that adding the ‚Äúright amount‚Äù of noise to stochastic gradient
ascent iterates leads to samples from the target posterior as the step size is annealed. Stochastic
gradient Hamiltonian Monte Carlo (SGHMC) [6] builds on this idea, but importantly incorporates
the efficient exploration provided by the HMC momentum term. A key insight in that paper was that
the naƒ±Ãàve stochastic gradient variant of HMC actually leads to an incorrect stationary distribution
(also see [4]); instead a modification to the dynamics underlying HMC is needed to account for
1
the stochastic gradient noise. Variants of both SGLD and SGHMC with further modifications to
improve efficiency have also recently been proposed [1, 13, 7].
In the plethora of past MCMC methods that explicitly leverage continuous dynamics‚Äîincluding
HMC, Riemann manifold HMC, and the stochastic gradient methods‚Äîthe focus has been on show-
ing that the intricate dynamics leave the target posterior distribution invariant. Innovating in this
arena requires constructing novel dynamics and simultaneously ensuring that the target distribution
is the stationary distribution. This can be quite challenging, and often requires significant physical
and geometrical intuition [6, 13, 7]. A natural question, then, is whether there exists a general recipe
for devising such continuous-dynamic MCMC methods that naturally lead to invariance of the target
distribution. In this paper, we answer this question to the affirmative. Furthermore, and quite im-
portantly, our proposed recipe is complete. That is, any continuous Markov process (with no jumps)
with the desired invariant distribution can be cast within our framework, including HMC, Riemann
manifold HMC, SGLD, SGHMC, their recent variants, and any future developments in this area.
That is, our method provides a unifying framework of past algorithms, as well as a practical tool for
devising new samplers and testing the correctness of proposed samplers.
The recipe involves defining a (stochastic) system parameterized by two matrices: a positive
semidefinite diffusion matrix, D(z), and a skew-symmetric curl matrix, Q(z), where z = (Œ∏, r)
with Œ∏ our model parameters of interest and r a set of auxiliary variables. The dynamics are then
written explicitly in terms of the target stationary distribution and these two matrices. By varying
the choices of D(z) and Q(z), we explore the space of MCMC methods that maintain the correct
invariant distribution. We constructively prove the completeness of this framework by converting a
general continuous Markov process into the proposed dynamic structure.
For any given D(z), Q(z), and target distribution, we provide practical algorithms for implement-
ing either full-data or minibatch-based variants of the sampler. In Sec. 3.1, we cast many previous
continuous-dynamic samplers in our framework, finding their D(z) and Q(z). We then show how
these existing D(z) and Q(z) building blocks can be used to devise new samplers; we leave the
question of exploring the space of D(z) and Q(z) well-suited to the structure of the target distribu-
tion as an interesting direction for future research. In Sec. 3.2 we demonstrate our ability to construct
new and relevant samplers by proposing stochastic gradient Riemann Hamiltonian Monte Carlo, the
existence of which was previously only speculated. We demonstrate the utility of this sampler on
synthetic data and in a streaming Wikipedia analysis using latent Dirichlet allocation [5].
2 A Complete Stochastic Gradient MCMC Framework
We start with the standard MCMC goal of drawing samples from a target distribution, which we take
to be the posterior p(Œ∏|S) of model parameters Œ∏ ‚àà Rd given an observed dataset S. Throughout,
we assume i.i.d. data x ‚àº p(x|Œ∏). We write p(Œ∏|S) ‚àù exp(‚àíU(Œ∏)), with potential function
U(Œ∏) = ‚àí
‚àë
x‚ààS log p(x|Œ∏) ‚àí log p(Œ∏). Algorithms like HMC [12, 10] further augment the space
of interest with auxiliary variables r and sample from p(z|S) ‚àù exp(‚àíH(z)), with Hamiltonian
H(z) = H(Œ∏, r) = U(Œ∏) + g(Œ∏, r), such that
‚à´
exp(‚àíg(Œ∏, r))dr = constant. (1)
Marginalizing the auxiliary variables gives us the desired distribution on Œ∏. In this paper, we gener-
ically consider z as the samples we seek to draw; z could represent Œ∏ itself, or an augmented state
space in which case we simply discard the auxiliary variables to perform the desired marginalization.
As in HMC, the idea is to translate the task of sampling from the posterior distribution to simulating
from a continuous dynamical system which is used to define a Markov transition kernel. That is,
over any interval h, the differential equation defines a mapping from the state at time t to the state
at time t + h. One can then discuss the evolution of the distribution p(z, t) under the dynamics, as
characterized by the Fokker-Planck equation for stochastic dynamics [14] or the Liouville equation
for deterministic dynamics [20]. This evolution can be used to analyze the invariant distribution of
the dynamics, ps(z). When considering deterministic dynamics, as in HMC, a jump process must
be added to ensure ergodicity. If the resulting stationary distribution is equal to the target posterior,
then simulating from the process can be equated with drawing samples from the posterior.
If the stationary distribution is not the target distribution, a Metropolis-Hastings (MH) correction
can often be applied. Unfortunately, such correction steps require a costly computation on the entire
2
dataset. Even if one can compute the MH correction, if the dynamics do not nearly lead to the
correct stationary distribution, then the rejection rate can be high even for short simulation periods
h. Furthermore, for many stochastic gradient MCMC samplers, computing the probability of the
reverse path is infeasible, obviating the use of MH. As such, a focus in the literature is on defining
dynamics with the right target distribution, especially in large-data scenarios where MH corrections
are computationally burdensome or infeasible.
2.1 Devising SDEs with a Specified Target Stationary Distribution
Generically, all continuous Markov processes that one might consider for sampling can be written
as a stochastic differential equation (SDE) of the form:
dz = f(z)dt+
‚àö
2D(z)dW(t), (2)
where f(z) denotes the deterministic drift and often relates to the gradient of H(z), W(t) is a d-
dimensional Wiener process, and D(z) is a positive semidefinite diffusion matrix. Clearly, however,
not all choices of f(z) and D(z) yield the stationary distribution ps(z) ‚àù exp(‚àíH(z)).
When D(z) = 0, as in HMC, the dynamics of Eq. (2) become deterministic. Our exposition focuses
on SDEs, but our analysis applies to deterministic dynamics as well. In this case, our framework‚Äî
using the Liouville equation in place of Fokker-Planck‚Äîensures that the deterministic dynamics
leave the target distribution invariant. For ergodicity, a jump process must be added, which is not
considered in our recipe, but tends to be straightforward (e.g., momentum resampling in HMC).
To devise a recipe for constructing SDEs with the correct stationary distribution, we propose writing
f(z) directly in terms of the target distribution:
f(z) = ‚àí
[
D(z) + Q(z)
]
‚àáH(z) + Œì(z), Œìi(z) =
d‚àë
j=1
‚àÇ
‚àÇzj
(
Dij(z) + Qij(z)
)
. (3)
Here, Q(z) is a skew-symmetric curl matrix representing the deterministic traversing effects seen
in HMC procedures. In contrast, the diffusion matrix D(z) determines the strength of the Wiener-
process-driven diffusion. Matrices D(z) and Q(z) can be adjusted to attain faster convergence to
the posterior distribution. A more detailed discussion on the interpretation of D(z) and Q(z) and
the influence of specific choices of these matrices is provided in the Supplement.
Importantly, as we show in Theorem 1, sampling the stochastic dynamics of Eq. (2) (according
to ItoÃÇ integral) with f(z) as in Eq. (3) leads to the desired posterior distribution as the stationary
distribution: ps(z) ‚àù exp(‚àíH(z)). That is, for any choice of positive semidefinite D(z) and skew-
symmetric Q(z) parameterizing f(z), we know that simulating from Eq. (2) will provide samples
from p(Œ∏ | S) (discarding any sampled auxiliary variables r) assuming the process is ergodic.
Theorem 1. ps(z) ‚àù exp(‚àíH(z)) is a stationary distribution of the dynamics of Eq. (2) if f(z) is
restricted to the form of Eq. (3), with D(z) positive semidefinite and Q(z) skew-symmetric. If D(z)
is positive definite, or if ergodicity can be shown, then the stationary distribution is unique.
Proof. The equivalence of ps(z) and the target p(z | S) ‚àù exp(‚àíH(z)) can be shown using the
Fokker-Planck description of the probability density evolution under the dynamics of Eq. (2) :
‚àÇtp(z, t) =‚àí
‚àë
i
‚àÇ
‚àÇzi
(
fi(z)p(z, t)
)
+
‚àë
i,j
‚àÇ2
‚àÇzi‚àÇzj
(
Dij(z)p(z, t)
)
. (4)
Eq. (4) can be further transformed into a more compact form [19, 16]:
‚àÇtp(z, t) =‚àáT ¬∑
(
[D(z) + Q(z)] [p(z, t)‚àáH(z) +‚àáp(z, t)]
)
. (5)
We can verify that p(z | S) is invariant under Eq. (5) by calculating
[
e‚àíH(z)‚àáH(z) +‚àáe‚àíH(z)
]
=
0. If the process is ergodic, this invariant distribution is unique. The equivalence of the compact form
was originally proved in [16]; we include a detailed proof in the Supplement for completeness.
3
All Continuous  
Markov Processes 
f(z) defined by  
D(z), Q(z) 
Processes with 
ps(z) = p(z|S) 
Figure 1: The red space represents the set of all continuous Markov
processes. A point in the black space represents a continuous
Markov process defined by Eqs. (2)-(3) based on a specific choice of
D(z),Q(z). By Theorem 1, each such point has stationary distribution
ps(z) = p(z | S). The blue space represents all continuous Markov
processes with ps(z) = p(z | S). Theorem 2 states that these blue and
black spaces are equivalent (there is no gap, and any point in the blue
space has a corresponding D(z),Q(z) in our framework).
2.2 Completeness of the Framework
An important question is what portion of samplers defined by continuous Markov processes with
the target invariant distribution can we define by iterating over all possible D(z) and Q(z)? In
Theorem 2, we show that for any continuous Markov process with the desired stationary distribution,
ps(z), there exists an SDE as in Eq. (2) with f(z) defined as in Eq. (3). We know from the Chapman-
Kolmogorov equation [9] that any continuous Markov process with stationary distribution ps(z) can
be written as in Eq. (2), which gives us the diffusion matrix D(z). Theorem 2 then constructively
defines the curl matrix Q(z). This result implies that our recipe is complete. That is, we cover all
possible continuous Markov process samplers in our framework. See Fig. 1.
Theorem 2. For the SDE of Eq. (2), suppose its stationary probability density function ps(z) u-
niquely exists, and that
[
fi(z)p
s(z)‚àí
‚àëd
j=1
‚àÇ
‚àÇŒ∏j
(
Dij(z)p
s(z)
)]
is integrable with respect to the
Lebesgue measure, then there exists a skew-symmetric Q(z) such that Eq. (3) holds.
The integrability condition is usually satisfied when the probability density function uniquely exists.
A constructive proof for the existence of Q(z) is provided in the Supplement.
2.3 A Practical Algorithm
In practice, simulation relies on an -discretization of the SDE, leading to a full-data update rule
zt+1 ‚Üê zt ‚àí t
[(
D(zt) + Q(zt)
)
‚àáH(zt) + Œì(zt)
]
+N (0, 2tD(zt)). (6)
Calculating the gradient of H(z) involves evaluating the gradient of U(Œ∏). For a stochastic gradient
method, the assumption is that U(Œ∏) is too computationally intensive to compute as it relies on a sum
over all data points (see Sec. 2). Instead, such stochastic gradient algorithms examine independently
sampled data subsets SÃÉ ‚äÇ S and the corresponding potential for these data:
UÃÉ(Œ∏) = ‚àí|S|
|SÃÉ|
‚àë
x‚ààSÃÉ
log p(x|Œ∏)‚àí log p(Œ∏); SÃÉ ‚äÇ S. (7)
The specific form of Eq. (7) implies that UÃÉ(Œ∏) is an unbiased estimator of U(Œ∏). As such, a gradient
computed based on UÃÉ(Œ∏)‚Äîcalled a stochastic gradient [15]‚Äîis a noisy, but unbiased estimator
of the full-data gradient. The key question in many of the existing stochastic gradient MCMC
algorithms is whether the noise injected by the stochastic gradient adversely affects the stationary
distribution of the modified dynamics (using ‚àáUÃÉ(Œ∏) in place of ‚àáU(Œ∏)). One way to analyze the
impact of the stochastic gradient is to make use of the central limit theorem and assume
‚àáUÃÉ(Œ∏) = ‚àáU(Œ∏) +N (0,V(Œ∏)), (8)
resulting in a noisy Hamiltonian gradient ‚àáHÃÉ(z) = ‚àáH(z) + [N (0,V(Œ∏)),0]T . Simply plugging
in‚àáHÃÉ(z) in place of‚àáH(z) in Eq. (6) results in dynamics with an additional noise term (D(zt) +
Q(zt)
)
[N (0,V(Œ∏)),0]T . To counteract this, assume we have an estimate BÃÇt of the variance of this
additional noise satisfying 2D(zt) ‚àí tBÃÇt  0 (i.e., positive semidefinite). With small , this is
always true since the stochastic gradient noise scales down faster than the added noise. Then, we
can attempt to account for the stochastic gradient noise by simulating
zt+1 ‚Üê zt ‚àí t
[(
D(zt) + Q(zt)
)
‚àáHÃÉ(zt) + Œì(zt)
]
+N (0, t(2D(zt)‚àí tBÃÇt)). (9)
This provides our stochastic gradient‚Äîor minibatch‚Äî variant of the sampler. In Eq. (9), the noise
introduced by the stochastic gradient is multiplied by t (and the compensation by 2t ), implying that
4
the discrepancy between these dynamics and those of Eq. (6) approaches zero as t goes to zero. As
such, in this infinitesimal step size limit, since Eq. (6) yields the correct invariant distribution, so
does Eq. (9). This avoids the need for a costly or potentially intractable MH correction. However,
having to decrease t to zero comes at the cost of increasingly small updates. We can also use a finite,
small step size in practice, resulting in a biased (but faster) sampler. A similar bias-speed tradeoff
was used in [11, 3] to construct MH samplers, in addition to being used in SGLD and SGHMC.
3 Applying the Theory to Construct Samplers
3.1 Casting Previous MCMC Algorithms within the Proposed Framework
We explicitly state how some recently developed MCMC methods fall within the proposed frame-
work based on specific choices of D(z), Q(z) and H(z) in Eq. (2) and (3). For the stochastic
gradient methods, we show how our framework can be used to ‚Äúreinvent‚Äù the samplers by guiding
their construction and avoiding potential mistakes or inefficiencies caused by naƒ±Ãàve implementations.
Hamiltonian Monte Carlo (HMC) The key ingredient in HMC [8, 12] is Hamiltonian dynamics,
which simulate the physical motion of an object with position Œ∏, momentum r, and mass M on an
frictionless surface as follows (typically, a leapfrog simulation is used instead):{
Œ∏t+1 ‚Üê Œ∏t + tM‚àí1rt
rt+1 ‚Üê rt ‚àí t‚àáU(Œ∏t).
(10)
Eq. (10) is a special case of the proposed framework with z = (Œ∏, r), H(Œ∏, r) = U(Œ∏) + 12r
TM‚àí1r,
Q(Œ∏, r) =
(
0 ‚àíI
I 0
)
and D(Œ∏, r) = 0.
Stochastic Gradient Hamiltonian Monte Carlo (SGHMC) As discussed in [6], simply replac-
ing ‚àáU(Œ∏) by the stochastic gradient‚àáUÃÉ(Œ∏) in Eq. (10) results in the following updates:
Naive :
{
Œ∏t+1 ‚Üê Œ∏t + tM‚àí1rt
rt+1 ‚Üê rt ‚àí t‚àáUÃÉ(Œ∏t) ‚âà rt ‚àí t‚àáU(Œ∏t) +N (0, 2tV(Œ∏t)),
(11)
where the ‚âà arises from the approximation of Eq. (8). Careful study shows that Eq. (11) cannot be
rewritten into our proposed framework, which hints that such a naƒ±Ãàve stochastic gradient version of
HMC is not correct. Interestingly, the authors of [6] proved that this naƒ±Ãàve version indeed does not
have the correct stationary distribution. In our framework, we see that the noise termN (0, 2tD(z))
is paired with a D(z)‚àáH(z) term, hinting that such a term should be added to Eq. (11). Here,
D(Œ∏, r) =
(
0 0
0 V(Œ∏)
)
, which means we need to add D(z)‚àáH(z) = V(Œ∏)‚àárH(Œ∏, r) =
V(Œ∏)M‚àí1r. Interestingly, this is the correction strategy proposed in [6], but through a physical
interpretation of the dynamics. In particular, the term V(Œ∏)M‚àí1r (or, generically, CM‚àí1r where
C  V(Œ∏)) has an interpretation as friction and leads to second order Langevin dynamics:{
Œ∏t+1 ‚Üê Œ∏t + tM‚àí1rt
rt+1 ‚Üê rt ‚àí t‚àáUÃÉ(Œ∏t)‚àí tCM‚àí1rt +N (0, t(2C‚àí tBÃÇt)).
(12)
Here, BÃÇt is an estimate of V(Œ∏t). This method now fits into our framework withH(Œ∏, r) and Q(Œ∏, r)
as in HMC, but with D(Œ∏, r) =
(
0 0
0 C
)
. This example shows how our theory can be used to
identify invalid samplers and provide guidance on how to effortlessly correct the mistakes; this is
crucial when physical intuition is not available. Once the proposed sampler is cast in our framework
with a specific D(z) and Q(z), there is no need for sampler-specific proofs, such as those of [6].
Stochastic Gradient Langevin Dynamics (SGLD) SGLD [17] proposes to use the following first
order (no momentum) Langevin dynamics to generate samples
Œ∏t+1 ‚Üê Œ∏t ‚àí tD‚àáUÃÉ(Œ∏t) +N (0, 2tD). (13)
This algorithm corresponds to taking z = Œ∏ withH(Œ∏) = U(Œ∏), D(Œ∏) = D, Q(Œ∏) = 0, and BÃÇt = 0.
As motivated by Eq. (9) of our framework, the variance of the stochastic gradient can be subtracted
from the sampler injected noise to make the finite stepsize simulation more accurate. This variant of
SGLD leads to the stochastic gradient Fisher scoring algorithm [1].
5
Stochastic Gradient Riemannian Langevin Dynamics (SGRLD) SGLD can be generalized to
use an adaptive diffusion matrix D(Œ∏). Specifically, it is interesting to take D(Œ∏) = G‚àí1(Œ∏), where
G(Œ∏) is the Fisher information metric. The sampler dynamics are given by
Œ∏t+1 ‚Üê Œ∏t ‚àí t[G(Œ∏t)‚àí1‚àáUÃÉ(Œ∏t) + Œì(Œ∏t)] +N (0, 2tG(Œ∏t)‚àí1). (14)
Taking D(Œ∏) = G(Œ∏)‚àí1, Q(Œ∏) = 0, and BÃÇt = 0, this SGRLD [13] method falls into our frame-
work with correction term Œìi(Œ∏) =
‚àë
j
‚àÇDij(Œ∏)
‚àÇŒ∏j
. It is interesting to note that in earlier literature [10],
Œìi(Œ∏) was taken to be 2 |G(Œ∏)|‚àí1/2
‚àë
j
‚àÇ
‚àÇŒ∏j
(
G‚àí1ij (Œ∏)|G(Œ∏)|1/2
)
. More recently, it was found that
this correction term corresponds to the distribution function with respect to a non-Lebesgue mea-
sure [18]; for the Lebesgue measure, the revised Œìi(Œ∏) was as determined by our framework [18].
Again, we have an example of our theory providing guidance in devising correct samplers.
Stochastic Gradient NoseÃÅ-Hoover Thermostat (SGNHT) Finally, the SGNHT [7] method in-
corporates ideas from thermodynamics to further increase adaptivity by augmenting the SGHMC
system with an additional scalar auxiliary variable, Œæ. The algorithm uses the following dynamics:Ô£±Ô£¥Ô£¥Ô£≤Ô£¥Ô£¥Ô£≥
Œ∏t+1 ‚Üê Œ∏t + trt
rt+1 ‚Üê rt ‚àí t‚àáUÃÉ(Œ∏t)‚àí tŒætrt +N (0, t(2A‚àí tBÃÇt))
Œæt+1 ‚Üê Œæt + t
(
1
d
rTt rt ‚àí 1
)
.
(15)
We can take z = (Œ∏, r, Œæ), H(Œ∏, r, Œæ) = U(Œ∏) +
1
2
rT r+
1
2d
(Œæ‚àíA)2, D(Œ∏, r, Œæ) =
(
0 0 0
0 A ¬∑ I 0
0 0 0
)
,
and Q(Œ∏, r, Œæ) =
(
0 ‚àíI 0
I 0 r/d
0 ‚àírT /d 0
)
to place these dynamics within our framework.
Summary In our framework, SGLD and SGRLD take Q(z) = 0 and instead stress the design of
the diffusion matrix D(z), with SGLD using a constant D(z) and SGRLD an adaptive, Œ∏-dependent
diffusion matrix to better account for the geometry of the space being explored. On the other hand,
HMC takes D(z) = 0 and focuses on the curl matrix Q(z). SGHMC combines SGLD with HMC
through non-zero D(Œ∏) and Q(Œ∏) matrices. SGNHT then extends SGHMC by taking Q(z) to be
state dependent. The relationships between these methods are depicted in the Supplement, which
likewise contains a discussion of the tradeoffs between these two matrices. In short, D(z) can
guide escaping from local modes while Q(z) can enable rapid traversing of low-probability regions,
especially when state adaptation is incorporated. We readily see that most of the product space
D(z)√óQ(z), defining the space of all possible samplers, has yet to be filled.
3.2 Stochastic Gradient Riemann Hamiltonian Monte Carlo
In Sec. 3.1, we have shown how our framework unifies existing samplers. In this section, we now use
our framework to guide the development of a new sampler. While SGHMC [6] inherits the momen-
tum term of HMC, making it easier to traverse the space of parameters, the underlying geometry of
the target distribution is still not utilized. Such information can usually be represented by the Fisher
information metric [10], denoted as G(Œ∏), which can be used to precondition the dynamics. For our
proposed system, we consider H(Œ∏, r) = U(Œ∏) + 12r
T r, as in HMC/SGHMC methods, and modify
the D(Œ∏, r) and Q(Œ∏, r) of SGHMC to account for the geometry as follows:
D(Œ∏, r) =
(
0 0
0 G(Œ∏)‚àí1
)
; Q(Œ∏, r) =
(
0 ‚àíG(Œ∏)‚àí1/2
G(Œ∏)‚àí1/2 0
)
.
We refer to this algorithm as stochastic gradient Riemann Hamiltonian Monte Carlo (SGRHMC).
Our theory holds for any positive definite G(Œ∏), yielding a generalized SGRHMC (gSGRHMC)
algorithm, which can be helpful when the Fisher information metric is hard to compute.
A naƒ±Ãàve implementation of a state-dependent SGHMC algorithm might simply (i) precondition the
HMC update, (ii) replace ‚àáU(Œ∏) by ‚àáUÃÉ(Œ∏), and (iii) add a state-dependent friction term on the
order of the diffusion matrix to counterbalance the noise as in SGHMC, resulting in:
Naive :
{
Œ∏t+1 ‚Üê Œ∏t + tG(Œ∏t)‚àí1/2rt
rt+1 ‚Üê rt ‚àí tG(Œ∏t)‚àí1/2‚àáŒ∏UÃÉ(Œ∏t)‚àí tG(Œ∏t)‚àí1rt +N (0, t(2G(Œ∏t)‚àí1 ‚àí tBÃÇt)).
(16)
6
Algorithm 1: Generalized Stochastic Gradient Riemann Hamiltonian Monte Carlo
initialize (Œ∏0, r0)
for t = 0, 1, 2 ¬∑ ¬∑ ¬∑ do
optionally, periodically resample momentum r as r(t) ‚àº N (0, I)
Œ∏t+1 ‚Üê Œ∏t + tG(Œ∏t)‚àí1/2rt, Œ£t ‚Üê t(2G(Œ∏t)‚àí1 ‚àí tBÃÇt)
rt+1 ‚Üê rt ‚àí tG(Œ∏t)‚àí1/2‚àáŒ∏UÃÉ(Œ∏t) + t‚àáŒ∏(G(Œ∏t)‚àí1/2)‚àí tG(Œ∏t)‚àí1rt +N
(
0,Œ£t
)
end
1
2
SGLD
1
2
SGHMC
1
2
Naive gSGRHMC
1
2
gSGRHMC
0.000
0.005
0.010
0.015
0.020
K
-
L
D
iv
er
ge
nc
e
0 2 4 6 8 10
0
0.5
1
1.5
2
2.5
log
3
(Steps/100)+1
K
‚àí
L
 D
iv
er
ge
nc
e
 
 
SGLD
SGHMC
gSGRHMC
Figure 2: Left: For two simulated 1D distributions defined by U(Œ∏) = Œ∏2/2 (one peak) and U(Œ∏) = Œ∏4‚àí2Œ∏2
(two peaks), we compare the KL divergence of methods: SGLD, SGHMC, the naƒ±Ãàve SGRHMC of Eq. (16), and
the gSGRHMC of Eq. (17) relative to the true distribution in each scenario (left and right bars labeled by 1 and
2). Right: For a correlated 2D distribution with U(Œ∏1, Œ∏2) = Œ∏41/10 + (4 ¬∑ (Œ∏2 + 1.2) ‚àí Œ∏21)2/2, we see that
our gSGRHMC most rapidly explores the space relative to SGHMC and SGLD. Contour plots of the distribution
along with paths of the first 10 sampled points are shown for each method.
However, as we show in Sec. 4.1, samples from these dynamics do not converge to the desired
distribution. Indeed, this system cannot be written within our framework. Instead, we can simply
follow our framework and, as indicated by Eq. (9), consider the following update rule:{
Œ∏t+1 ‚Üê Œ∏t + tG(Œ∏t)‚àí1/2rt
rt+1 ‚Üê rt ‚àí t[G(Œ∏)‚àí1/2‚àáŒ∏UÃÉ(Œ∏t) +‚àáŒ∏
(
G(Œ∏t)
‚àí1/2
)
‚àíG(Œ∏t)‚àí1rt] +N (0, t(2G(Œ∏t)‚àí1 ‚àí tBÃÇt)),
(17)
which includes a correction term ‚àáŒ∏
(
G(Œ∏)‚àí1/2
)
, with i-th component
‚àë
j
‚àÇ
‚àÇŒ∏j
(
G(Œ∏)‚àí1/2
)
ij
. The
practical implementation of gSGRHMC is outlined in Algorithm 1.
4 Experiments
In Sec. 4.1, we show that gSGRHMC can excel at rapidly exploring distributions with complex
landscapes. We then apply SGRHMC to sampling in a latent Dirichlet allocation (LDA) model on
a large Wikipedia dataset in Sec. 4.2. The Supplement contains details on the specific samplers
considered and the parameter settings used in these experiments.
4.1 Synthetic Experiments
In this section we aim to empirically (i) validate the correctness of our recipe and (ii) assess the
effectiveness of gSGRHMC. In Fig. 2(left), we consider two univariate distributions (shown in the
Supplement) and compare SGLD, SGHMC, the naƒ±Ãàve state-adaptive SGHMC of Eq. (16), and our
proposed gSGRHMC of Eq. (17). See the Supplement for the form of G(Œ∏). As expected, the naƒ±Ãàve
implementation does not converge to the target distribution. In contrast, the gSGRHMC algorithm
obtained via our recipe indeed has the correct invariant distribution and efficiently explores the dis-
tributions. In the second experiment, we sample a bivariate distribution with strong correlation. The
results are shown in Fig. 2(right). The comparison between SGLD, SGHMC, and our gSGRHMC
method shows that both a state-dependent preconditioner and Hamiltonian dynamics help to make
the sampler more efficient than either element on its own.
7
Original LDA Expanded Mean
Parameter Œ∏ Œ≤kw = Œ∏kw Œ≤kw = Œ∏kw‚àë
w Œ∏kw
Prior p(Œ∏) p(Œ∏k) = Dir(Œ±) p(Œ∏kw) = Œì(Œ±, 1)
Method Average Runtime per 100 Docs
SGLD 0.778s
SGHMC 0.815s
SGRLD 0.730s
SGRHMC 0.806s
0 2000 4000 6000 8000 10000
1000
1500
2000
2500
3000
3500
Number of Documents
Pe
rp
le
xi
ty
 
 
SGLD
SGHMC
SGRLD
SGRHMC
Figure 3: Upper Left: Expanded mean parameterization of the LDA model. Lower Left: Average runtime per
100 Wikipedia entries for all methods. Right: Perplexity versus number of Wikipedia entries processed.
4.2 Online Latent Dirichlet Allocation
We also applied SGRHMC (with G(Œ∏) = diag(Œ∏)‚àí1, the Fisher information metric) to an online
latent Dirichlet allocation (LDA) [5] analysis of topics present in Wikipedia entries. In LDA, each
topic is associated with a distribution over words, with Œ≤kw the probability of word w under topic k.
Each document is comprised of a mixture of topics, with œÄ(d)k the probability of topic k in document
d. Documents are generated by first selecting a topic z(d)j ‚àº œÄ(d) for the jth word and then drawing
the specific word from the topic as x(d)j ‚àº Œ≤z(d)j . Typically, œÄ
(d) and Œ≤k are given Dirichlet priors.
The goal of our analysis here is inference of the corpus-wide topic distributions Œ≤k. Since the
Wikipedia dataset is large and continually growing with new articles, it is not practical to carry out
this task over the whole dataset. Instead, we scrape the corpus from Wikipedia in a streaming man-
ner and sample parameters based on minibatches of data. Following the approach in [13], we first
analytically marginalize the document distributions œÄ(d) and, to resolve the boundary issue posed by
the Dirichlet posterior of Œ≤k defined on the probability simplex, use an expanded mean parameter-
ization shown in Figure 3(upper left). Under this parameterization, we then compute ‚àá log p(Œ∏|x)
and, in our implementation, use boundary reflection to ensure the positivity of parameters Œ∏kw. The
necessary expectation over word-specific topic indicators z(d)j is approximated using Gibbs sampling
separately on each document, as in [13]. The Supplement contains further details.
For all the methods, we report results of three random runs. When sampling distributions with
mass concentrated over small regions, as in this application, it is important to incorporate geometric
information via a Riemannian sampler [13]. The results in Fig. 3(right) indeed demonstrate the im-
portance of Riemannian variants of the stochastic gradient samplers. However, there also appears to
be some benefits gained from the incorporation of the HMC term for both the Riemmannian and non-
Reimannian samplers. The average runtime for the different methods are similar (see Fig. 3(lower
left)) since the main computational bottleneck is the gradient evaluation. Overall, this application
serves as an important example of where our newly proposed sampler can have impact.
5 Conclusion
We presented a general recipe for devising MCMC samplers based on continuous Markov process-
es. Our framework constructs an SDE specified by two matrices, a positive semidefinite D(z) and a
skew-symmetric Q(z). We prove that for any D(z) and Q(z), we can devise a continuous Markov
process with a specified stationary distribution. We also prove that for any continuous Markov pro-
cess with the target stationary distribution, there exists a D(z) and Q(z) that cast the process in our
framework. Our recipe is particularly useful in the more challenging case of devising stochastic gra-
dient MCMC samplers. We demonstrate the utility of our recipe in ‚Äúreinventing‚Äù previous stochastic
gradient MCMC samplers, and in proposing our SGRHMC method. The efficiency and scalability
of the SGRHMC method was shown on simulated data and a streaming Wikipedia analysis.
Acknowledgments
This work was supported in part by ONR Grant N00014-10-1-0746, NSF CAREER Award IIS-1350133, and
the TerraSwarm Research Center sponsored by MARCO and DARPA. We also thank Mr. Lei Wu for helping
with the proof of Theorem 2 and Professors Ping Ao and Hong Qian for many discussions.
8
References
[1] S. Ahn, A. Korattikara, and M. Welling. Bayesian posterior sampling via stochastic gradient
Fisher scoring. In Proceedings of the 29th International Conference on Machine Learning
(ICML‚Äô12), 2012.
[2] S. Ahn, B. Shahbaba, and M. Welling. Distributed stochastic gradient MCMC. In Proceeding
of 31st International Conference on Machine Learning (ICML‚Äô14), 2014.
[3] R. Bardenet, A. Doucet, and C. Holmes. Towards scaling up Markov chain Monte Carlo:
An adaptive subsampling approach. In Proceedings of the 30th International Conference on
Machine Learning (ICML‚Äô14), 2014.
[4] M. Betancourt. The fundamental incompatibility of scalable Hamiltonian Monte Carlo and
naive data subsampling. In Proceedings of the 31th International Conference on Machine
Learning (ICML‚Äô15), 2015.
[5] D.M. Blei, A.Y. Ng, and M.I. Jordan. Latent dirichlet allocation. Journal of Machine Learning
Research, 3:993‚Äì1022, March 2003.
[6] T. Chen, E.B. Fox, and C. Guestrin. Stochastic gradient Hamiltonian Monte Carlo. In Pro-
ceeding of 31st International Conference on Machine Learning (ICML‚Äô14), 2014.
[7] N. Ding, Y. Fang, R. Babbush, C. Chen, R.D. Skeel, and H. Neven. Bayesian sampling using
stochastic gradient thermostats. In Advances in Neural Information Processing Systems 27
(NIPS‚Äô14). 2014.
[8] S. Duane, A.D. Kennedy, B.J. Pendleton, and D. Roweth. Hybrid Monte Carlo. Physics Letters
B, 195(2):216 ‚Äì 222, 1987.
[9] W. Feller. Introduction to Probability Theory and its Applications. John Wiley & Sons, 1950.
[10] M. Girolami and B. Calderhead. Riemann manifold Langevin and Hamiltonian Monte Carlo
methods. Journal of the Royal Statistical Society Series B, 73(2):123‚Äì214, 03 2011.
[11] A. Korattikara, Y. Chen, and M. Welling. Austerity in MCMC land: Cutting the Metropolis-
Hastings budget. In Proceedings of the 30th International Conference on Machine Learning
(ICML‚Äô14), 2014.
[12] R.M. Neal. MCMC using Hamiltonian dynamics. Handbook of Markov Chain Monte Carlo,
54:113‚Äì162, 2010.
[13] S. Patterson and Y.W. Teh. Stochastic gradient Riemannian Langevin dynamics on the proba-
bility simplex. In Advances in Neural Information Processing Systems 26 (NIPS‚Äô13). 2013.
[14] H. Risken and T. Frank. The Fokker-Planck Equation: Methods of Solutions and Applications.
Springer, 1996.
[15] H. Robbins and S. Monro. A stochastic approximation method. The Annals of Mathematical
Statistics, 22(3):400‚Äì407, 09 1951.
[16] J. Shi, T. Chen, R. Yuan, B. Yuan, and P. Ao. Relation of a new interpretation of stochastic
differential equations to ItoÃÇ process. Journal of Statistical Physics, 148(3):579‚Äì590, 2012.
[17] M. Welling and Y.W. Teh. Bayesian learning via stochastic gradient Langevin dynamics. In
Proceedings of the 28th International Conference on Machine Learning (ICML‚Äô11), pages
681‚Äì688, June 2011.
[18] T. Xifara, C. Sherlock, S. Livingstone, S. Byrne, and M. Girolami. Langevin diffusions and
the Metropolis-adjusted Langevin algorithm. Statistics & Probability Letters, 91:14‚Äì19, 2014.
[19] L. Yin and P. Ao. Existence and construction of dynamical potential in nonequilibrium process-
es without detailed balance. Journal of Physics A: Mathematical and General, 39(27):8593,
2006.
[20] R. Zwanzig. Nonequilibrium Statistical Mechanics. Oxford University Press, 2001.
9
